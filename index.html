<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Admin V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
    </style>
</head>
<body class="min-h-screen p-6">

    <div class="max-w-3xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-red-500 tracking-tight">üéÖ Admin Control Panel</h1>
                <p class="text-xs text-gray-500 mt-1">Connected to: <span class="font-mono text-gray-400">santa_v4_fixed</span></p>
            </div>
            <div id="game-status" class="mt-4 md:mt-0 text-sm font-mono px-4 py-2 rounded bg-gray-800 text-gray-400 border border-gray-700">
                Waiting for connection...
            </div>
        </header>

        <div class="bg-red-900/10 border border-red-500/20 rounded-xl p-6 mb-8 backdrop-blur-sm">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-red-400 mb-1">Emergency Reset</h2>
                    <p class="text-gray-400 text-sm max-w-md">
                        This wipes the current game and sends all screens back to the "Setup" page. 
                        <strong class="text-red-300">Use this if the game is stuck.</strong>
                    </p>
                </div>
                <button id="reset-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg shadow-red-900/20 whitespace-nowrap w-full md:w-auto">
                    ‚ö†Ô∏è RESET GAME
                </button>
            </div>
        </div>

        <div class="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-gray-700 bg-gray-800">
                <h2 class="text-xl font-bold text-white">Player Status</h2>
                <p class="text-gray-400 text-sm mt-1">
                    Mistake correction: If "Arjun" accidentally clicked "Alvin", find Alvin below and click <span class="text-yellow-500 font-bold">Undo</span>.
                </p>
            </div>
            
            <div id="player-list" class="divide-y divide-gray-700/50">
                <div class="p-8 text-center text-gray-500">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-500 mx-auto mb-2"></div>
                    Loading game data...
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Config
        const firebaseConfig = {
            apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM",
            authDomain: "my-chain-reaction-game.firebaseapp.com",
            projectId: "my-chain-reaction-game",
            storageBucket: "my-chain-reaction-game.appspot.com",
            messagingSenderId: "32751418407",
            appId: "1:32751418407:web:ff8244007ef2b099d56202"
        };

        // CRITICAL: This must match the index.html APP_ID
        const APP_ID = 'santa_v4_fixed'; 

        // 2. Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const els = {
            list: document.getElementById('player-list'),
            status: document.getElementById('game-status'),
            resetBtn: document.getElementById('reset-all-btn')
        };

        // 3. Listen to Game State
        const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'state');

        onSnapshot(gameRef, (docSnap) => {
            if (!docSnap.exists()) {
                els.status.textContent = "‚ö™ NO GAME ACTIVE";
                els.status.className = "text-sm font-mono px-4 py-2 rounded bg-gray-800 text-gray-500 border border-gray-700";
                els.list.innerHTML = `
                    <div class="p-12 text-center">
                        <p class="text-gray-500 text-lg">Game has not been started yet.</p>
                        <p class="text-gray-600 text-sm mt-2">Go to the main page and click "Start Game"</p>
                    </div>`;
                return;
            }

            const data = docSnap.data();
            
            // Update Status Badge
            if (data.status === 'STARTED') {
                els.status.innerHTML = `<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>GAME LIVE`;
                els.status.className = "text-sm font-mono px-4 py-2 rounded bg-green-900/30 text-green-400 border border-green-800";
            } else {
                els.status.textContent = "‚ö™ SETUP MODE";
                els.status.className = "text-sm font-mono px-4 py-2 rounded bg-yellow-900/30 text-yellow-500 border border-yellow-800";
            }

            renderPlayers(data.participants || [], data.revealed || []);
        });

        // 4. Render Logic
        function renderPlayers(participants, revealed) {
            if (!participants.length) return;

            els.list.innerHTML = '';
            
            // Sort: Revealed people first (so you can fix mistakes easily), then alphabetical
            const sorted = [...participants].sort((a, b) => {
                const aDone = revealed.includes(a);
                const bDone = revealed.includes(b);
                if (aDone === bDone) return a.localeCompare(b);
                return aDone ? -1 : 1;
            });

            sorted.forEach(name => {
                const isRevealed = revealed.includes(name);
                
                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-4 hover:bg-gray-700/50 transition ${isRevealed ? 'bg-gray-800/30' : ''}`;
                
                // Status Text
                let statusHtml = isRevealed 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-300 border border-green-700">
                         <svg class="mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>
                         Revealed
                       </span>` 
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300">
                         Waiting
                       </span>`;

                // Action Button
                let actionHtml = isRevealed 
                    ? `<button class="undo-btn bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-md" data-name="${name}">
                         Undo Reveal ‚Ü∫
                       </button>`
                    : `<span class="text-gray-600 text-xs italic">No action needed</span>`;

                row.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isRevealed ? 'bg-gray-700 text-gray-400' : 'bg-blue-900 text-blue-200'}">
                            ${name.charAt(0)}
                        </div>
                        <div>
                            <div class="text-base font-semibold ${isRevealed ? 'text-gray-400' : 'text-white'}">${name}</div>
                            <div class="mt-1">${statusHtml}</div>
                        </div>
                    </div>
                    <div>${actionHtml}</div>
                `;

                els.list.appendChild(row);
            });

            // Add Event Listeners to dynamic buttons
            document.querySelectorAll('.undo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => undoReveal(e.target.dataset.name));
            });
        }

        // 5. Actions
        async function undoReveal(name) {
            if (!confirm(`CONFIRM UNDO:\n\nPut "${name}" back into the dropdown list?\n\nDo this only if the wrong person was selected.`)) return;
            
            try {
                await updateDoc(gameRef, {
                    revealed: arrayRemove(name)
                });
                // Snapshot will auto-update UI
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        els.resetBtn.addEventListener('click', async () => {
            const code = prompt("Type 'RESET' to wipe the game and return everyone to Setup:");
            if (code !== 'RESET') return;

            try {
                // Changing status to RESET forces index.html to reload to setup screen
                await setDoc(gameRef, {
                    status: 'RESET',
                    participants: [], 
                    revealed: []
                });
                alert("Game has been reset.");
            } catch (e) {
                alert("Error: " + e.message);
            }
        });

    </script>
</body>
</html>
